const cds = require('..'), {i18n} = cds.env
const I18nFiles = require ('./files')


class I18nBundle {

  constructor (options={}) {
    this.files = new I18nFiles (options)
    this.file = this.files.basename
  }

  #translations = {}

  /** The default texts to use as fallbacks if a requested translation is not found. */
  get defaults() { return super.defaults = this.texts4 (i18n.default_language, this.fallback) }
  get fallback() { return super.fallback = this.texts4 ('',false) }

  /** Synonym for {@link at `this.at`} */
  get for() { return this.at }


  /**
   * Looks up the entry for the given key and locale.
   * - if `locale` is omitted, the current locale is used.
   * - if `args` are provided, fills in placeholders with them.
   * @returns {string|undefined}
   */
  at (key, locale, args) {
    if (typeof locale !== 'string') [ args, locale ] = [ locale, cds.context?.locale ?? i18n.default_language ]
    if (typeof key === 'object') key = this.key4(key)
    let t = this.texts4 (locale) [key]
    if (t && args) t = t.replace (/{(\w+)}/g, (_,k) => args[k])
    return t
  }


  /**
   * Calls this.{@link at}() for all specified locales and returns an dictionary of results.
   * @example cds.i18n.labels.all('CreatedBy')
   */
  all (key, locales, args) {
    if (!key) return { ...this.translations() } // eslint-disable-line no-constant-binary-expression
    const all={}, translations = this.translations4 (locales)
    for (let locale in translations) {
      let t = translations[locale][key]
      if (t && args) t = t.replace (/{(\w+)}/g, (_,k) => args[k])
      all[locale] = t
    }
    return all
  }


  /**
   * Used by {@link at `this.at()`} to determine the i18n key for a given CSN definition.
   */
  key4 (d) {
    const anno = d['@Common.Label'] || d['@title'] || d['@UI.HeaderInfo.TypeName']
    if (anno) return /{i18n>([^}]+)}/.exec(anno)?.[1] || anno
    else return d.name || d.type // if any
  }


  /**
   * Returns translated texts for a specific locale.
   */
  texts4 (locale='', _defaults) {
    const $ = this.#translations;             if (locale in $) return $[locale]
    const suffix = locale.replace(/-/g,'_');  if (suffix in $) return $[locale] = $[suffix]
    // nothing cached yet, load content and create translations ...
    let all = this.files.content4 (locale, suffix)    // load content from all folders
    if (all.length === 0 && suffix.includes('_')) {   // nothing found, try w/o region ...
      const lang = suffix.match(/(\w+)_/)[1]          // i.e. en_UK => en
      if (lang in $) return $[locale] = $[lang]       // already cached -> leave method
      else all = this.files.content4 (lang, lang)     // load content for language only
    }
    const defaults = (_defaults ?? this.defaults) || Object.prototype
    const texts = i18n.fatjson ? Object.assign ({},defaults) : Object.create (defaults)
    return $[locale] = $[suffix] = Object.assign (texts, ...all)
  }


  /**
   * Returns all translations for an array of locales or all locales.
   * @example { de, fr } = cds.i18n.labels.translations('de','fr')
   * @param { 'all' | string[] } [locale]
   * @returns {{ [locale:string]: Record<string,string> }}
   */
  translations4 (...locales) {
    let first = locales[0]
    if (first == null)  locales = cds.env.i18n.languages
    if (first == 'all') locales = this.files.locales()
    else if (Array.isArray(first)) locales = first
    return locales.reduce ((all,l) => (all[l] = this.texts4(l),all), {})
  }


  /**
   * Returns a proxy to lazily access all translations by locales as object properties.
   * @example { de, fr } = cds.i18n.labels.translations()
   */
  translations() {
    const b = this, files = b.files, pd = { configurable: true, enumerable: true }
    return new Proxy (this.#translations, {
      *[Symbol.iterator](){ for (let l of files.locales()) yield [ l, b.texts4(l) ]},
      ownKeys(){ return files.locales() }, getOwnPropertyDescriptor(){ return pd },
      has(t,p) { return files.locales().includes(p) },
      get(t,p) { return this[p] ?? b.texts4(p) },
    })
  }
}

module.exports = I18nBundle
