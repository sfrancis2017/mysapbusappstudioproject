const { reject, getRejectReason } = require('./utils')

const _getRequiresAsArray = definition =>
  definition['@requires']
    ? Array.isArray(definition['@requires'])
      ? definition['@requires']
      : [definition['@requires']]
    : false

function handler(req) {
  if (req.user._is_privileged) {
    // > skip checks
    return
  }

  const requires = _getRequiresAsArray(this.definition)

  if (!requires || requires.some(role => req.user.is(role))) return
  reject(req, getRejectReason(req, '@requires', this.definition))
}

handler._initial = true

module.exports = handler
